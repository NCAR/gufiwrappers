# gufiwrappers

**gufiwrappers** is a collection of python scripts for NCAR users
of our Grand Unified File Index (GUFI) installation for querying
and reporting against out data holdings under different CISL 
maintained NCAR storage devices. The syntax of Raw **GUFI** 
query tools are somewhat terse and output most often 
requires further processing for meaningful and actionable reports. 
Hence is the reason for coming up with these wrappers.

The **GUFI** tools (primarily gufi_query or multi-threaded breadth
first search in a tree) generates raw reports, in csv
format, one file per thread. Considering the format and mechanism of
generation of this input the **gufiwrappers** tool set is broken 
into two parts,
1. gwrap (generates raw reports and optionally a file list))
2. grprt (generates statistics from raw report)
So functionally users need to execute these two commands in 
sequence.

Both the scripts are available in users path after loading **gufiwrappers**
module on Casper nodes. Both of these scripts have `-h/--help` option
for basic usage details. In this page little more elabore usage detail
and few example output is explained.


## gwrap
**grap** needs to be run to generate raw data querying **GUFI** DB.
Optionally it can add filters to the query and generate the list of
files (`--list=filename,onwer,..`) and/or add filters on owners, projects
(HPSS only), modification and access time as described in this help
outout below. Few example use cases are documented below.
<pre>
usage: gwrap [-h] [--gufitmp-dir= path-name]
             [--list= filename,size,owner,project,mtime,atime]
             [--owners= User1,User2,..] [--projects= Proj1,Proj2,..]
             [--write-period= YYYY[MM[DD]]-YYYY[MM[DD]]]
             [--read-period= YYYY[MM[DD]]-YYYY[MM[DD]]]
             [--nthreads number-of-threads] [--verbose]
             Absolute Path of filesystem directory

Generate Cache DB and optionally a filename list for a given filesystem tree
querying GUFI DB

positional arguments:
  Absolute Path of filesystem directory
                        Absolute path of the filesystem tree located in either
                        in glade, campaign or HPSS

optional arguments:
  -h, --help            show this help message and exit
  --gufitmp-dir= path-name
                        Absolute path name to store the GUFI query output
                        default: /gpfs/fs1/scratch/<username>/gufi_tmp
  --list= filename,size,owner,project,mtime,atime
                        Generate list of files with one or more of the
                        attributes from filename, size, owner, project, mtime,
                        atime in order as specified delimited by comma(,).
  --owners= User1,User2,..
                        for content owned only by users User1,User2,..
  --projects= Proj1,Proj2,..
                        for content associated with projects Proj1,Proj2..,
                        (applicable only in HPSS)
  --write-period= YYYY[MM[DD]]-YYYY[MM[DD]]
                        for content written during the time window
                        YYYY[MM[DD]]-YYYY[MM[DD]] either of begin or end
                        period may be omitted for open interval but not both.
                        For time specification 4-digit year is required,
                        2-digit month may be specified, if month is specified
                        2-digit may be specified.
  --read-period= YYYY[MM[DD]]-YYYY[MM[DD]]
                        for content read during time the window
                        YYYY[MM[DD]]-YYYY[MM[DD]] either of begin or end
                        period may be omitted for open interval but not both.
                        For time specification 4-digit year is required,
                        2-digit month may be specified, if month is specified
                        2-digit may be specified.
  --nthreads number-of-threads
                        Number of threads to run GUFI query
  --verbose, -v         Adds verbosity
</pre>

The results are stored under 
1. `gufitmp`/raw (the raw output from gufi_query) 
2. `gufitmp`/scripts (the scripts submitted to gufi_query)
3. `gufitmp`/reports (the final reports, file lists etc.) 
4. `gufitmp`/log (the errors etc.)

## grprt
**grprt** generates report from raw data generated by **gwrap**. The short
command line help output is here.
<pre>
usage: grprt.py [-h] [--gufitmp-dir= path-name]
                [--by-users | --by-projects | --by-subdirs-of= [Parent directory]]
                [--filter-by-unames= [User1,User2,..] [[User1,User2,..] ...]]
                [--filter-by-projects= [Project1,Project2,..]
                [[Project1,Project2,..] ...]]
                [--nthreads number-of-cores or processes]
                [--nsbins number-of-histogram bins [8]]
                treename

Generate report from raw data

positional arguments:
  treename              Absolute path of the filesystem tree located in either
                        in glade, campaign or HPSS

optional arguments:
  -h, --help            show this help message and exit
  --gufitmp-dir= path-name
                        Absolute path name to store the GUFI query output
                        default: /gpfs/fs1/scratch/sghosh/gufi_tmp
  --by-users            report by user-name / user-ids (if mapping not found)
  --by-projects         report by project-name / project-id (if mapping not
                        found) HPSS only
  --by-subdirs-of= [Parent directory]
                        report by subdirectories of this parent directory
  --filter-by-unames= [User1,User2,..] [[User1,User2,..] ...]
                        Report only for User1[,User2]..
  --filter-by-projects= [Project1,Project2,..] [[Project1,Project2,..] ...]
                        Report only for Project1[,Project2]..
  --nthreads number-of-cores or processes
                        Number of cores / threads to run
  --nsbins number-of-histogram bins [8]
                        Number of write / read stat histogram bins in report
</pre>
